# qsub /lustre/home/client/fas/sbsc/ga254/scripts/GSHL/sc2_population_bin.sh

#PBS -S /bin/bash 
#PBS -q fas_normal 
#PBS -l walltime=24:00:00
#PBS -l nodes=1:ppn=8
#PBS -V
#PBS -o /scratch/fas/sbsc/ga254/stdout
#PBS -e /scratch/fas/sbsc/ga254/stderr

module purge 
module unload Libs/GDAL/1.11.2 
module load Langs/Python/2.7.3
module load Libs/GDAL/1.10.0
# module load Libraries/OSGEO/1.10.0
module load Libraries/ARMADILLO

exit 



export DIR=/lustre/scratch/client/fas/sbsc/ga254/dataproces/GSHL

# gdalwarp -overwrite -te -180 -90 +180 +90 -tr 0.008333333333333333333 0.008333333333333333333 -tap -t_srs EPSG:4326 -r bilinear -co COMPRESS=DEFLATE -co ZLEVEL=9 $DIR/GHS_POP_GPW42015_GLOBE_R2015A_54009_1k_v1_0/GHS_POP_GPW42015_GLOBE_R2015A_54009_1k_v1_0.tif  $DIR/GHS_POP_GPW42015_GLOBE_R2015A_54009_1k_v1_0/GHS_POP_GPW42015_GLOBE_R2015A_54009_1k_v1_0_WGS84.tif


# echo 1.5 2.5 3.5 4.5 5.5 6.5 7.5 8.5 9.5 | xargs -n 1 -P 8 bash -c $'
# MIN=$1
# oft-stat -i $DIR/GHS_POP_GPW42015_GLOBE_R2015A_54009_1k_v1_0/GHS_POP_GPW42015_GLOBE_R2015A_54009_1k_v1_0_WGS84.tif -o $DIR/GHS_POP_GPW42015_GLOBE_R2015A_54009_1k_v1_0/AVG_bin$MIN.txt  -um    $DIR/GHS_BUILT_LDS2014_GLOBE_R2016A_54009_1k_v1_0/GHS_BUILT_LDS2014_GLOBE_R2016A_54009_1k_v1_0_WGS84_bin$MIN.tif -nostd

# oft-stat-sum -i $DIR/GHS_POP_GPW42015_GLOBE_R2015A_54009_1k_v1_0/GHS_POP_GPW42015_GLOBE_R2015A_54009_1k_v1_0_WGS84.tif -o $DIR/GHS_POP_GPW42015_GLOBE_R2015A_54009_1k_v1_0/SUM_bin$MIN.txt  -um    $DIR/GHS_BUILT_LDS2014_GLOBE_R2016A_54009_1k_v1_0/GHS_BUILT_LDS2014_GLOBE_R2016A_54009_1k_v1_0_WGS84_bin$MIN.tif -nostd

# oft-stat -i $DIR/GHS_POP_GPW42015_GLOBE_R2015A_54009_1k_v1_0/GHS_POP_GPW42015_GLOBE_R2015A_54009_1k_v1_0_WGS84.tif -o $DIR/GHS_POP_GPW42015_GLOBE_R2015A_54009_1k_v1_0/AVG_clump_bin$MIN.txt  -um    $DIR/GHS_BUILT_LDS2014_GLOBE_R2016A_54009_1k_v1_0/GHS_BUILT_LDS2014_GLOBE_R2016A_54009_1k_v1_0_WGS84_bin${MIN}_clump.tif -nostd

# oft-stat-sum -i $DIR/GHS_POP_GPW42015_GLOBE_R2015A_54009_1k_v1_0/GHS_POP_GPW42015_GLOBE_R2015A_54009_1k_v1_0_WGS84.tif -o $DIR/GHS_POP_GPW42015_GLOBE_R2015A_54009_1k_v1_0/SUM_clump_bin$MIN.txt  -um    $DIR/GHS_BUILT_LDS2014_GLOBE_R2016A_54009_1k_v1_0/GHS_BUILT_LDS2014_GLOBE_R2016A_54009_1k_v1_0_WGS84_bin${MIN}_clump.tif -nostd

# ' _ 


# rm -f   $DIR/GHS_BUILT_LDS2014_GLOBE_R2016A_54009_1k_v1_0_shp/GHS_BUILT_LDS2014_GLOBE_R2016A_54009_1k_v1_0_WGS84_bin*.*

# echo 5.5 6.5 7.5 8.5 9.5 | xargs -n 1 -P 8 bash -c $'
# MIN=$1
# rm -f  $DIR/GHS_BUILT_LDS2014_GLOBE_R2016A_54009_1k_v1_0_shp/GHS_BUILT_LDS2014_GLOBE_R2016A_54009_1k_v1_0_WGS84_bin${MIN}.*
# gdal_polygonize.py -f "ESRI Shapefile" -mask   $DIR/GHS_BUILT_LDS2014_GLOBE_R2016A_54009_1k_v1_0/GHS_BUILT_LDS2014_GLOBE_R2016A_54009_1k_v1_0_WGS84_bin${MIN}.tif  $DIR/GHS_BUILT_LDS2014_GLOBE_R2016A_54009_1k_v1_0/GHS_BUILT_LDS2014_GLOBE_R2016A_54009_1k_v1_0_WGS84_bin${MIN}.tif   $DIR/GHS_BUILT_LDS2014_GLOBE_R2016A_54009_1k_v1_0_shp/GHS_BUILT_LDS2014_GLOBE_R2016A_54009_1k_v1_0_WGS84_bin${MIN}.shp  
 
# ' _ 


# rm -f /lustre/scratch/client/fas/sbsc/ga254/dataproces/GEOING/reg_CRU/1km/*    

# ls  /lustre/scratch/client/fas/sbsc/ga254/dataproces/GEOING/reg_CRU/cru_ts3.23.????.????.tmp.dat_1.0deg.reg.tif   | xargs -n 1 -P 8 bash -c $'
# file=$1
# filename=$(basename $file .tif )
# gdalwarp -co COMPRESS=DEFLATE -co ZLEVEL=9  -r near  -srcnodata -9999 -dstnodata -9999  -tr 0.0083333333333333333 0.0083333333333333333 $file  /lustre/scratch/client/fas/sbsc/ga254/dataproces/GEOING/reg_CRU/1km/${filename}_1km.tif  
# ' _ 

rm -f /lustre/scratch/client/fas/sbsc/ga254/dataproces/GEOING/reg_CRU/shp/* 

echo 5.5 6.5 7.5 8.5 9.5 | xargs -n 1 -P 8 bash -c $'
MIN=$1

for file in /lustre/scratch/client/fas/sbsc/ga254/dataproces/GEOING/reg_CRU/1km/*.tif ; do 
filename=$(basename $file .tif )

pkextract -r mean -f "ESRI Shapefile" -srcnodata -9999 -polygon  --bname DegMean -s  $DIR/GHS_BUILT_LDS2014_GLOBE_R2016A_54009_1k_v1_0_shp/GHS_BUILT_LDS2014_GLOBE_R2016A_54009_1k_v1_0_WGS84_bin${MIN}.shp  -i   /lustre/scratch/client/fas/sbsc/ga254/dataproces/GEOING/reg_CRU/1km/${filename}.tif  -o  /lustre/scratch/client/fas/sbsc/ga254/dataproces/GEOING/reg_CRU/shp/${filename}_${MIN}Mean.shp  

pkextract -r stdev  -f  "ESRI Shapefile" -srcnodata -9999 -polygon  --bname DegStev   -s  $DIR/GHS_BUILT_LDS2014_GLOBE_R2016A_54009_1k_v1_0_shp/GHS_BUILT_LDS2014_GLOBE_R2016A_54009_1k_v1_0_WGS84_bin${MIN}.shp  -i   /lustre/scratch/client/fas/sbsc/ga254/dataproces/GEOING/reg_CRU/1km/${filename}.tif     -o  /lustre/scratch/client/fas/sbsc/ga254/dataproces/GEOING/reg_CRU/shp/${filename}_${MIN}Stdev.shp

pksetmask  -co COMPRESS=DEFLATE -co ZLEVEL=9 \
              -m  $DIR/GHS_BUILT_LDS2014_GLOBE_R2016A_54009_1k_v1_0/GHS_BUILT_LDS2014_GLOBE_R2016A_54009_1k_v1_0_WGS84_bin${MIN}.tif   -msknodata 0  -nodata -9999 \
              -i  /lustre/scratch/client/fas/sbsc/ga254/dataproces/GEOING/reg_CRU/1km/${filename}.tif  \
              -o  /lustre/scratch/client/fas/sbsc/ga254/dataproces/GEOING/reg_CRU/1km/${filename}_${MIN}mskbin.tif

pkgetmask  -ot Byte  -co COMPRESS=DEFLATE -co ZLEVEL=9 -min -9990  -max 999999999999  -data 1 -nodata   0 -ct /tmp/color.txt     -1   /lustre/scratch/client/fas/sbsc/ga254/dataproces/GEOING/reg_CRU/1km/${filename}_${MIN}mskbin.tif   /lustre/scratch/client/fas/sbsc/ga254/dataproces/GEOING/reg_CRU/1km/${filename}_${MIN}mskbin_msk.tif

oft-stat -i   /lustre/scratch/client/fas/sbsc/ga254/dataproces/GEOING/reg_CRU/1km/${filename}_${MIN}mskbin.tif   -o  /lustre/scratch/client/fas/sbsc/ga254/dataproces/GEOING/reg_CRU/1km/${filename}_${MIN}mskbin_mean.txt  -um  /lustre/scratch/client/fas/sbsc/ga254/dataproces/GEOING/reg_CRU/1km/${filename}_${MIN}mskbin_msk.tif -mm 

oft-stat-sum  -i   /lustre/scratch/client/fas/sbsc/ga254/dataproces/GEOING/reg_CRU/1km/${filename}_${MIN}mskbin.tif   -o  /lustre/scratch/client/fas/sbsc/ga254/dataproces/GEOING/reg_CRU/1km/${filename}_${MIN}mskbin_sum.txt  -um  /lustre/scratch/client/fas/sbsc/ga254/dataproces/GEOING/reg_CRU/1km/${filename}_${MIN}mskbin_msk.tif  -nostd 

done 

' _


exit 



# for UNIT in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 11003 13283 1667 10687 11730 612 3260 13632 20000 20001 14064 13496 20000 20001  ; do bsub  -W 24:00 -M 70000  -R "rusage[mem=70000]" -n 1  -R "span[hosts=1]"  -o /gpfs/scratch60/fas/sbsc/ga254/grace0/stdout/sc05_ReconditioningHydrodemCarving.sh.%J.out -e /gpfs/scratch60/fas/sbsc/ga254/grace0/stderr/sc05_ReconditioningHydrodemCarving.sh.%J.err bash /gpfs/home/fas/sbsc/ga254/scripts/RIVER_NETWORK/sc05_ReconditioningHydrodemCarving_UNIT.sh $UNIT C  ; done 

# for UNIT in 2524_1215_13496_1191  ; do for EUROASIA  in LEFT CENTER RIGHT ; do bsub  -W 24:00 -M 70000  -R "rusage[mem=70000]" -n 1  -R "span[hosts=1]"  -o /gpfs/scratch60/fas/sbsc/ga254/grace0/stdout/sc05_ReconditioningHydrodemCarving.sh.%J.out -e /gpfs/scratch60/fas/sbsc/ga254/grace0/stderr/sc05_ReconditioningHydrodemCarving.sh.%J.err bash /gpfs/home/fas/sbsc/ga254/scripts/RIVER_NETWORK/sc05_ReconditioningHydrodemCarving_UNIT.sh $UNIT $EUROASIA  ; done ; done  

#  bash /gpfs/home/fas/sbsc/ga254/scripts/RIVER_NETWORK/sc05_ReconditioningHydrodemCarving_UNIT.sh 13283  madagascar 

# for testing 
# for UNIT in 13283 1667 10687 11730 612 11003 20000  ; do bsub  -W 24:00 -M 70000  -R "rusage[mem=70000]" -n 1  -R "span[hosts=1]"  -o /gpfs/scratch60/fas/sbsc/ga254/grace0/stdout/sc05_ReconditioningHydrodemCarving.sh.%J.out -e /gpfs/scratch60/fas/sbsc/ga254/grace0/stderr/sc05_ReconditioningHydrodemCarving.sh.%J.err bash /gpfs/home/fas/sbsc/ga254/scripts/RIVER_NETWORK/sc05_ReconditioningHydrodemCarving_UNIT.sh $UNIT C  ; done 

# for UNIT in 20000  ; do bsub  -W 24:00 -M 70000  -R "rusage[mem=70000]" -n 1  -R "span[hosts=1]"  -o /gpfs/scratch60/fas/sbsc/ga254/grace0/stdout/sc05_ReconditioningHydrodemCarving.sh.%J.out -e /gpfs/scratch60/fas/sbsc/ga254/grace0/stderr/sc05_ReconditioningHydrodemCarving.sh.%J.err bash /gpfs/home/fas/sbsc/ga254/scripts/RIVER_NETWORK/sc05_ReconditioningHydrodemCarving_UNIT.sh $UNIT C  ; done 


# 11003 8209728    indonesia   #  
# 13283 11853191   MADAGASCAR  # 
# 1667 13166954    canada island 
# 10687 14013636     guinea    # 
# 11730 15288346   canada island  
# 612 23165874     canada island  
# 3260 153178164   greenland 
# 13632 158925073    australia  
# 20000 354955227   South America  
# 20001 576949211  africa  
# 14064 633972786  North america 
# 13496 1494258173 euroasia 
# 14196 8336810723 sea 

cd /gpfs/scratch60/fas/sbsc/ga254/grace0/dataproces/RIVER_NETWORK/grassdb 
export DIR=/gpfs/scratch60/fas/sbsc/ga254/grace0/dataproces/RIVER_NETWORK

source  /gpfs/home/fas/sbsc/ga254/scripts/general/enter_grass7.0.2.sh   /gpfs/scratch60/fas/sbsc/ga254/grace0/dataproces/RIVER_NETWORK/grassdb/loc_river/PERMANENT 

g.list rast 

export file=/gpfs/scratch60/fas/sbsc/ga254/grace0/dataproces/RIVER_NETWORK/unit/UNIT${1}msk.tif
export UNIT=$(basename $file msk.tif ) 
export EUROASIA=$2

echo $UNIT

if [ $UNIT  = "UNIT2524_1215_13496_1191" ]  &&  [  $EUROASIA  =  "CENTER"    ] ; then 
gdal_translate -co COMPRESS=LZW  -projwin  $(  getCorners4Gtranslate  $file )  /gpfs/scratch60/fas/sbsc/ga254/grace0/dataproces/RIVER_NETWORK/GSW_unit/occurrence_250m_EUROASIA.tif    /dev/shm/occurrence_250m_$UNIT.tif 
pksetmask -m  $file      -msknodata 0 -nodata 0 -i         /dev/shm/occurrence_250m_$UNIT.tif   -o    /gpfs/scratch60/fas/sbsc/ga254/grace0/dataproces/RIVER_NETWORK/GSW_unit/occurrence_250m_$UNIT.tif 
rm -f /dev/shm/occurrence_250m_$UNIT.tif 
fi 

if [ $UNIT  = "UNIT2524_1215_13496_1191" ]  ; then export DEM=be75_grd_LandEnlarge_EUROASIA ; export OCCURANCE=occurrence_250m_EUROASIA ; fi 


if [ $UNIT != "UNIT2524_1215_13496_1191" ] ; then export DEM=be75_grd_LandEnlarge          ; export OCCURANCE=occurrence_250m          
gdal_translate -co COMPRESS=LZW  -projwin  $(  getCorners4Gtranslate  $file )  /gpfs/scratch60/fas/sbsc/ga254/grace0/dataproces/GSW/input/occurrence_250m.tif                          /dev/shm/occurrence_250m_$UNIT.tif 
pksetmask -m  $file   -msknodata 0 -nodata 0 -i  /dev/shm/occurrence_250m_$UNIT.tif  -o   /gpfs/scratch60/fas/sbsc/ga254/grace0/dataproces/RIVER_NETWORK/GSW_unit/occurrence_250m_$UNIT.tif 
rm -f /dev/shm/occurrence_250m_$UNIT.tif 
fi 

cp  $HOME/.grass7/grass$$     $HOME/.grass7/rc${UNIT}${EUROASIA}
export GISRC=$HOME/.grass7/rc${UNIT}${EUROASIA}

rm -fr  $DIR/grassdb/loc_river/${UNIT}${EUROASIA}
g.mapset  -c  mapset=$UNIT${EUROASIA} location=loc_river  dbase=$DIR/grassdb   --quiet --overwrite 

echo create mapset $UNIT
cp $DIR/grassdb/loc_river/PERMANENT/WIND $DIR/grassdb/loc_river/${UNIT}${EUROASIA}/WIND

rm -f  $DIR/grassdb/loc_river/$UNIT${EUROASIA}/.gislock

g.gisenv 

r.in.gdal in=$file    out=$UNIT   --overwrite


g.region   raster=${UNIT}   --o #   n=35 s=30 e=0 w=-10  #  
r.mask -r  --quiet
r.mask     raster=${UNIT}   --o


if [ $EUROASIA = LEFT ]    ; then  g.region  e=53        res=0:00:07.5  ; fi 
if [ $EUROASIA = CENTER ]  ; then  g.region  w=-20  e=92 res=0:00:07.5  ; fi 
if [ $EUROASIA = RIGHT ]   ; then  g.region  w=90        res=0:00:07.5  ; fi 

echo log transform the water layer 

# # plot ( wa ,  100  * log(wa+1) / ( max(log(0+1)) -  min (log(100+1)))   )  ; log(1)=0   # log(OCCURANCE@PERMANENT + 1) /  4.615121  

                                                             #  gose from 0 to 4  

##  log( $OCCURANCE@PERMANENT + 1) /  4.615121  # log of the occurance /  4.615121  goes from 0 to 1 ; 0 no water at all 1 always water 

# first condition 
# log(occurence ) * altitude (from 10 to 30)

N=1
echo $N
rm -f  /dev/shm/number${UNIT}.txt 
for DIM in $( seq 10 2 20 ) ; do   # 30
N=$( expr $N + 1)  ; echo $DIM $N >>  /dev/shm/number${UNIT}.txt 
r.mapcalc " ${OCCURANCE}_log${N}$UNIT = if ( $OCCURANCE@PERMANENT < 101 ,  ( log( $OCCURANCE@PERMANENT + 1) /  4.615121 * $DIM                                            ), 0 )"   --overwrite
done 

# ## log(occurence ) * altitude (from 10 to 200) * power2 of ( 1 - normalized_stde ) ; normalize_stdev goes from 1 mountain area 0 to flat area.   
N=100
echo $N
for DIM in $( seq 10 10 200 ) ; do  # 200
N=$( expr $N + 1)  ; echo $DIM $N >>  /dev/shm/number${UNIT}.txt 
r.mapcalc " ${OCCURANCE}_log${N}$UNIT = if ( $OCCURANCE@PERMANENT < 101 ,  ( log( $OCCURANCE@PERMANENT + 1) /  4.615121 * $DIM * (( 1 - be75_grd_LandEnlarge_std_norm)^2)), 0 )"   --overwrite
done 

# ## log(occurence ) * altitude (from 10 to 200) * ( 1 - normalized_stde ) ; normalize_stdev goes from 1 mountain area 0 to flat area.   
N=200
echo $N
for DIM in $( seq 10 10 200 ) ; do 
N=$( expr $N + 1) ; echo $DIM  $N >>  /dev/shm/number${UNIT}.txt 
r.mapcalc " ${OCCURANCE}_log${N}$UNIT = if ( $OCCURANCE@PERMANENT < 101 ,  ( log( $OCCURANCE@PERMANENT + 1) /  4.615121 * $DIM * (( 1 - be75_grd_LandEnlarge_std_norm))), 0 )"   --overwrite
done

# ## log(occurence ) * altitude (from 10 to 200) * power2 of ( normalized_stde ) ; normalize_stdev goes from 1 mountain area 0 to flat area.   

N=300
echo $N

for DIM in $( seq 10 10 200 ) ; do 
N=$( expr $N + 1 )  ; echo $DIM  $N >>  /dev/shm/number${UNIT}.txt 
r.mapcalc " ${OCCURANCE}_log${N}$UNIT = if ( $OCCURANCE@PERMANENT < 101 ,  ( log( $OCCURANCE@PERMANENT + 1) /  4.615121 * $DIM * (( be75_grd_LandEnlarge_std_norm)^2)), 0 )"   --overwrite
done 

###  log(occurence ) * altitude (from 10 to 200) * ( normalized_stde ) ; normalize_stdev goes from 1 mountain area 0 to flat area.   

N=400
echo $N
for DIM in $( seq 10 10 200 ) ; do 
N=$( expr $N + 1) ; echo $DIM  $N >>  /dev/shm/number.${UNIT}txt 
r.mapcalc " ${OCCURANCE}_log${N}$UNIT = if ( $OCCURANCE@PERMANENT < 101 ,  ( log( $OCCURANCE@PERMANENT + 1) /  4.615121 * $DIM * (( be75_grd_LandEnlarge_std_norm))), 0 )"   --overwrite
done

r.mapcalc " ${OCCURANCE}_null_1$UNIT = if ( $OCCURANCE@PERMANENT == 0 ||  $OCCURANCE@PERMANENT == 255 ,  null()  , 1     )"   --overwrite

for GROW in 1.01  ; do 

export GROW

echo r.grow  
r.grow  input=${OCCURANCE}_null_1$UNIT   output=${OCCURANCE}_G_null_1_2$UNIT    radius=$GROW  new=1 old=2      --overwrite 
r.mapcalc  "${OCCURANCE}_G_null_1$UNIT  = if ( ${OCCURANCE}_G_null_1_2$UNIT == 1   , 1  , null()  )"   --overwrite

cat  /dev/shm/number${UNIT}.txt  | xargs -n 2 -P 1 bash -c $'  
DIM=$1
CARV=$2

echo  carving 
r.mapcalc "${DEM}_carv100$UNIT  = ${DEM}@PERMANENT  -  $CARV   "  --overwrite

echo  procedure to smoth the border 

for NEIG in 11  ; do 

echo start r.neighbors 
r.neighbors -c  input=${DEM}_carv100$UNIT output=${DEM}_carv100filter$UNIT  method=average  size=$NEIG  selection=${OCCURANCE}_G_null_1$UNIT  --overwrite 

echo start r.hydridem                                                                                               # memory=65000 
/gpfs/home/fas/sbsc/ga254/.grass7/addons/bin/r.hydrodem    input=${DEM}_carv100filter$UNIT   output=${DEM}_cond$UNIT  memory=65000  --overwrite 

echo start the output 
# r.out.gdal --overwrite -f -c createopt="COMPRESS=DEFLATE,ZLEVEL=9" format=GTiff nodata=-9999 type=Int16  input=${DEM}_cond$UNIT          output=/gpfs/scratch60/fas/sbsc/ga254/grace0/dataproces/RIVER_NETWORK/dem_unit/${DEM}_cond$UNIT.tif 
# r.out.gdal --overwrite -f -c createopt="COMPRESS=DEFLATE,ZLEVEL=9" format=GTiff nodata=-9999 type=Int16  input=${CARV}                   output=/gpfs/scratch60/fas/sbsc/ga254/grace0/dataproces/RIVER_NETWORK/output/GSW_unit/${CARV}.tif 

TRH=8
                                                                                                                               # memory=65000 
r.watershed -b elevation=${DEM}_cond$UNIT basin=basin stream=stream$UNIT  drainage=drainage$UNIT  accumulation=accumulation$UNIT memory=65000 threshold=$TRH --overwrite

r.out.gdal --overwrite -c createopt="COMPRESS=DEFLATE,ZLEVEL=9" type=UInt32 format=GTiff nodata=0   input=stream$UNIT output=/dev/shm/stream${UNIT}${EUROASIA}_GROW${GROW: -4:1}_NEIG${NEIG}_${DIM}_${CARV}.tif  
rm -f /dev/shm/stream${UNIT}${EUROASIA}_GROW${GROW: -4:1}_NEIG${NEIG}_${DIM}_${CARV}.aux.xml

pkcreatect -min 0 -max 1 > /tmp/color.txt 
pkgetmask -co COMPRESS=DEFLATE -co ZLEVEL=9 -ct /tmp/color.txt -ot Byte -min 0.5 -max 9999999999 -data 1 -i /dev/shm/stream${UNIT}${EUROASIA}_GROW${GROW: -4:1}_NEIG${NEIG}_${DIM}_${CARV}.tif -o $DIR/output/stream_unit/stream${UNIT}_GROW${GROW: -4:1}_NEIG${NEIG}_${DIM}_${CARV}.tif

rm -f  /tmp/color.txt   /dev/shm/stream${UNIT}${EUROASIA}_GROW${GROW: -4:1}_NEIG${NEIG}_${DIM}_${CARV}.tif  

r.mask  raster=stream$UNIT --o
r.mapcalc  " ${OCCURANCE}_STRbin$UNIT =   ${OCCURANCE}_null_1$UNIT   "   --overwrite 

r.report -n -h  units=c map=${OCCURANCE}_STRbin$UNIT   | awk -v GROW=${GROW: -4:1} -v NEIG=$NEIG  -v CARV=$CARV  -v DIM=$DIM    -F "|" \'{if(NR==5) print $(NF-1),GROW,NEIG,DIM,CARV}\' > /gpfs/scratch60/fas/sbsc/ga254/grace0/dataproces/RIVER_NETWORK/output/txt/${UNIT}${EUROASIA}_GROW${GROW: -4:1}_NEIG${NEIG}_${CARV}.txt 
r.mask  raster=${UNIT}   --o

r.out.gdal --overwrite -c createopt="COMPRESS=DEFLATE,ZLEVEL=9" type=UInt32 format=GTiff nodata=0  input=${OCCURANCE}_STRbin$UNIT  output=$DIR/output/stream_unit/stream${UNIT}${EUROASIA}_GROW${GROW: -4:1}_NEIG${NEIG}_${DIM}_${CARV}_STRbin.tif 

done 

' _ 

done

rm -f  /dev/shm/number${UNIT}.txt
# rm -fr  $DIR/grassdb/loc_river/${UNIT}